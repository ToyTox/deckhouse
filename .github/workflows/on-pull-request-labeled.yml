#
# THIS FILE IS GENERATED, PLEASE DO NOT EDIT.
#

# This workflow reacts to labels and restart workflows if needed.
# Cloud layout tests and deploy web are restarted only when PR is labeled.
# Validation workflow is restarted when PR is labeled or unlabeled.
name: Rerun workflows for pull request

on:
  pull_request_target:
    types: [labeled, unlabeled]
jobs:

  # <template: pull_request_info>
  pull_request_info:
    name: Get pull request reference
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.ref.outputs.ref }}
    steps:
      # Checkhout the merge commit
      - name: Checkout PR merge commit
        uses: actions/checkout@v2.4.0
        with:
          ref: "refs/pull/${{ github.event.number }}/merge"

      # Detect forbidden changes in external PR
      - name: Check for forbidden changes
        if: github.event.pull_request.head.repo.full_name != github.repository
        uses: technote-space/get-diff-action@v4.0.1
        with:
          PATTERNS: |
            ./.github/**
            ./.gitlab/**
            ./tools/**
            ./testing/**
            ./docs/**/js/**
            ./docs/**/css/**
            ./docs/**/images/**
            ./docs/**/assets/**

      # Stop workflow if external PR contains forbidden changes
      - name: Verify allowed changes in external PR
        if: github.event.pull_request.head.repo.full_name != github.repository && env.GIT_DIFF_FILTERED
        uses: actions/github-script@v5.0.0
        with:
          script: |
              core.setFailed('External PR contains forbidden changes.')

      # Set output
      - name: Return PR merge commit ref
        id: ref
        uses: actions/github-script@v5.0.0
        with:
          script: |
            core.setOutput('ref', `refs/pull/${ github.event.number }/merge`)
  # </template: pull_request_info>
  rerun_workflow_for_pull_request:
    name: Rerun workflow for pull request
    runs-on: ubuntu-latest
    needs:
      - pull_request_info
    steps:
      - name: Rerun workflow
        uses: actions/github-script@v5.0.0
        with:
          github-token: ${{ secrets.BOATSWAIN_GITHUB_TOKEN }}
          script: |
            const ci = require('./.github/scripts/js/ci');
            const ref = "${{ needs.pull_request_info.outputs.ref }}"
            return await ci.runWorkflowForPullRequest({ github, context, core, ref });
